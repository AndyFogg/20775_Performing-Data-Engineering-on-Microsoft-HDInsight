# Module 12: Developing Real-time Processing Solutions with Apache Storm

## Lab: Building an Apache Storm Application

### Exercise 1: Installing required software

#### Task 1: Install IntelliJ IDEA Community edition

> **Note**: If you already have all these components installed in the 20775A-LON-DEV virtual machine, you can skip this exercise.

1.  Ensure that the **MT17B-WS2016-NAT**, and **20775A-LON-DEV** virtual machines are running, and then log on to **20775A-LON-DEV** as **Admin** with the password **Pa55w.rd**.

2.  Start Internet Explorer, and browse to **https://www.jetbrains.com/idea/download/index.html#section=windows**.

3.  Under **Community**, click **Download**.

4.  In the message box, click **Run**.

5.  If the **User Account Control** dialog box appears, click **Yes**.

6.  In the **IntelliJ IDEA Community Edition Setup** wizard, on the **Welcome to the IntelliJ IDEA Community Edition Setup** page, click **Next**.

7.  On the **Choose Install Location** page, click **Next**.

8.  On the **Installation Options** page, select the **64-bit launcher** check box, and then click **Next**.

9.  On the **Choose Start Menu Folder** page, click **Install**.

10. On the **Completing IntelliJ IDEA Community Edition Setup** page, click **Finish**.

11. In Internet Explorer, browse to **https://www.scala-lang.org/download/**.

12. Under **Other resources**, click **scala-2.12.7.msi**.

13. In the message box, click **Run**.

14. In the **Scala Programming Language Distribution Setup** dialog box, on the welcome page, click **Next**.

15. On the **End-User License Agreement** page, click **I accept the terms in the License Agreement**, and then click **Next**.

16. On the **Custom Setup** page, click **Next**.

17. On the **Ready to install Scala Programming Language Distribution** page, click **Install**.

18. In the **User Account Control** dialog box, click **Yes**.

19. On the **Completed the Scala Programming Language Distribution Setup Wizard** page, click **Finish**.

20. Close Internet Explorer.

21. On the desktop, double-click **IntelliJ IDEA Community Edition**.

22. In the **Complete Installation** dialog box, click **Do not import settings**, and then click **OK**.

23. In the **JetBrains Privacy Policy** dialog box, scroll to the end of the text, and then click **Accept**.

24. In the **Data Sharing** dialog box, click **Don't send**.

25. In the **Customize IntelliJ IDEA** wizard, on the **Set UI theme** page, click **Next: Default plugins**.

26. On the **Tune IDEA to your tasks** page, click **Next: Featured plugins**.

27. On the **Download featured plugins** page, in the **Scala** section, click **Install**, and then click **Start using IntelliJ IDEA**.

#### Task 2: Configure IntelliJ IDEA

1.  In the **Welcome to IntelliJ IDEA** dialog box, click **Create New Project**.

2.  In the left-hand pane, click **Scala**, in the right-hand pane click **IDEA**, and then click **Next**.

3.  Under the **JDK** drop-down list box, click **Download JDK**. This action will open a web browser (Microsoft Edge or Internet Explorer).

4.  In the **Oracle** dialog box, click **AGREE AND PROCEED**.

5.  In the web browser, in the **Java SE Downloads** section, click the **Java Download** image button.

6.  In the **Java SE Development Kit** section, click **Accept License Agreement**, and then click the download link for the **Windows x64 EXE** version of the software.

7.  In the web browser message box, click **Save**.

8.  When the download has completed, in the web browser message box, click **Run**.

9.  If the **User Account Control** dialog box appears, click **Yes**.

10. In the **Java SE Development Kit Setup** wizard, on the welcome page, click **Next**.

11. On the optional features page, click **Next**.

12. When the installation has finished, click **Close**.

13. Close the web browser and return to the **New Project** dialog box in IntelliJ IDEA.

14. In the **New Project** dialog box, next to the **JDK** drop-down list box, click **New**.

15. In the **Select Home Directory for JDK** dialog box, browse to **C:\\Program Files\\Java**, click **jdk-11**, and then click **OK**.

16. In the **New Project** dialog box, next to the **Scala SDK** drop-down list box, click **Create**.

17. In the **Select JAR's for the new Scala SDK** dialog box, click **OK**.

18. In the **New Project** dialog box, click **Finish**.

19. In the **Windows Security Alert** dialog box for the **OpenJDK Platform binary**, click **Allow access**.

20. In the **Windows Security Alert** dialog box for **IntelliJ IDEA**, click **Allow access**.

21. In the **Tip of the Day** dialog box, clear **Show tips on startup**, and then click **Close**.
22. On the **File** menu, click **Settings**.

23. In the **Settings** dialog box, click **Plugins**.

24. In the **Plugins** pane, clear **Android Support**, and then click **Browse repositories**.

25. In the **Browse Repositories** dialog box, in the search box, type **Azure**.

26. Click **Azure Toolkit for IntelliJ**, and then click **Install**.

27. In the **Third-party Plugins Privacy Note** dialog box, click **Accept**.

28. In the **Browse Repositories** dialog box, click **Close**.

29. In the **Settings** dialog box, click **OK**.

30. In the **IDE and Plugin Updates** dialog box, click **Postpone**.

31. Close IntelliJ IDEA.

32. In the **Confirm Exit** dialog box, click **Exit**.

#### Task 3: Install PuTTY (if not already installed)

1.  In a web browser, navigate to **http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html**.

2.  Download the **putty.exe** file, saving it to a suitable folder on your local file system, such as C:\\putty.

3.  Optionally, create a shortcut to the putty.exe file on your desktop for convenience.

**Results**: At the end of this exercise, you will have a Windows client with IntelliJ IDEA Community Edition, the Java SE Development Kit, the Scala SDK, and the PuTTY tool installed for use later in the lab.

### Exercise 2: Configure event hubs

#### Task 1: Create an Event Hubs namespace

1.  On the Start menu, type **Internet Explorer**, and then press Enter.

2.  In Microsoft Internet ExplorerÂ®, navigate to **https://portal.azure.com**, and then sign in using the Microsoft account that is associated with your Azure Pass subscription.

3.  In the Azure Portal, click **+ Create a resource**, click **Internet of Things**, and then click **Event Hubs**.

4.  On the **Create Namespace** blade, type the following information, and then click **Create**:

    -   **Name**: \<*your name\>\<date*\>ehn (must be unique)

    -   **Pricing tier**: Basic

    -   **Subscription**: your subscription

    -   **Resource group (Create new)**: StormRG

    -   **Location**: Choose your region

    -   **Throughput Units**: 1

#### Task 2: Create an Event Hub

1.  When the namespace deployment has completed, in the Azure Portal, in the navigation on the left, click **All resources**, and then click **\<*your name\>\<date*\>ehn**.

2.  On the **\<*your name\>\<date*\>ehn** blade, click **+ Event Hub**.

3.  On the **Create Event Hub** blade, type the following information, and then click **Create**:

    -   **Name**: TaxiEventSource

    -   **Partition Count**: 2

#### Task 3: Record the Shared Access Primary Key

1.  On the **\<*your name\>\<date*\>ehn** blade, click **Shared access policies**, and then click **RootManageSharedAccessKey**.

2.  To the right of the **Primary Key** text box, click the **Click to copy** image button.

3.  On the Start menu, type **notepad**, and then press Enter.

4.  On the **Edit** menu, click **Paste**.

5.  On the **File** menu, click **Save As**.

6.  In the **Save As** dialog box, browse to **E:\\Labfiles\\Lab12**.

7.  In the **File name** text box, type **EventHubKey.txt**, and then click **Save**.

8.  Leave Notepad open while you complete the next exercise.

**Results**: At this end of this exercise, you will have an event hub and namespace configured in your Azure subscription.

### Exercise 3: Populate the event hub with data

#### Task 1: Configure the Event Hub Sender

1.  On the desktop, double-click **IntelliJ IDEA Community Edition**.

2.  If the **Tip of the Day** dialog box appears, click **Close**.

3.  On the **File** menu, click **Open**.

4.  In the **Open File or Project** dialog box, browse to **E:\\Labfiles\\Lab12\\Starter**, click the **EventHubSender** folder, and then click **OK**.

5.  In the **Open Project** dialog box, click **This Window**.

6.  On the **File** menu, click **Project Structure**.

7.  In the **Project Structure** dialog box, on the **Project** tab, in the **Project SDK** list, click **11 (java version "11")**, and then click **Apply**.

8.  On the **Global Libraries** tab, click **+**, and then click **Scala SDK**.

9.  In the **Select JAR's for the new Scala SDK** dialog box, click **OK**.

10. In the **Choose Modules** dialog box, click **OK**.

11. In the **Project Structure** dialog box, click **OK**.

12. On the **Run** menu, click **Edit Configurations**.

13. In the **Run/Debug Configurations** dialog box, click **+**, and then click **Application**.

14. In the **Name** box, type **MyEventHubSenderConfig**.

15. To the right of the **Main class** box, click the ellipsis (**...**) button.

16. In the **Choose Main Class** dialog box, click **EventhubsClientDriver**, and then click **OK**.

17. Click in the **Program arguments** box, and then press Shift+Enter.

18. In the **Program arguments** box, type the following, and then click **OK**:
    -   Replace **\<your name\>\<date\>ehn** with the name of your event hub.
    -   Replace **\<Primary Key\>** with the primary key you copied to notepad.
    ````
    --sourcefilename E:\Labfiles\Lab12\yellow_tripdata_2015-01.csv
    --eventhubs-namespace <your name><date>ehn
    --eventhubs-name TaxiEventSource
    --policy-name RootManageSharedAccessKey
    --policy-key <Primary Key>
    ````

#### Task 2: Run the Event Hub Sender

1.  On the **Run** menu, click **Run**.

2.  In the **Run** dialog box, click **MyEventHubSenderConfig**.

3.  When the project has compiled, the **Run** pane appears and displays data posted to the event hub.

4.  Allow the project to run for a few minutes to generate some data.

5.  On the **Run** menu, click **Stop 'MyEventHubSenderConfig'**.

6.  On the **File** menu, click **Close Project**.

**Results**: At the end of this exercise, you will have an event hub that contains taxi data. You will use this event hub as a source of data for the Storm topology.

### Exercise 4: Create a Storm streaming topology

#### Task 1: Add an Event Hubs Spout

1.  In the **Welcome to IntelliJ IDEA** dialog box, click **Open**.

2.  In the **Open File or Project** dialog box, browse to **E:\\Labfiles\\Lab12\\Starter\\StormProcessor - Exercise 4**, and then click **OK**.

3.  If the **Tip of the Day** dialog box appears, click **Close**.

4.  If the **Project JDK is not defined** message appears, complete the following steps:
    1.  Click **Setup JDK**.
    2.  In the **Select Project SDK** dialog box, click **OK**.

5.  If the **No Scala SDK in module** message appears, complete the following steps:
    1.  Click **Setup Scala SDK**.
    2.  In the **Add Scala Support** dialog box, click **OK**.

6.  In the **StormTopologyDriver.scala** file, locate the comment **// TODO: Configure and create the Event Hubs Spout**.

7.  On the next line, type the following code:
    ````
    val eventHubSpout: EventHubSpout = new EventHubSpout(eventHubSpoutConfig)
    ````

8.  Locate the comment **// TODO: Define the topology starting with the spout**.

9.  On the next line, type the following code:
    ````
    val numTasks : Int = eventHubSpoutConfig.getPartitionCount
    val topologyBuilder: TopologyBuilder = new TopologyBuilder
    topologyBuilder.setSpout("EventHubsSpout", eventHubSpout, numTasks).setNumTasks(numTasks)
    ````

10. On the **File** menu, click **Save All**.

#### Task 2: Add a Parser Bolt

1.  In the **Project** pane on the left, expand **src**, expand **stormprocessor**, and then  double-click **ParserBolt**.

2.  Locate the following comment: **// TODO: Define the fields passed on to the next bolt**.

3.  Within the **declareOutputFields** function, type the following code:
    ````
    outputFieldsDeclarer.declare(new Fields("pickup_datetime", "dropoff_datetime", "passenger_count", "distance", "pickup_latitude",
    "pickup_longitude", "dropoff_latitude", "droppoff_longitude,", "payment_type", "fare", "additional_charges", "tip"))
    ````

4.  Locate the following comment: **// TODO: Take the next record retrieved from Azure Event Hubs**.

5.  On the next line, type the following code:
    ````
    val data : String = input.getString(0)
    ````

6.  Locate the following comment: **// TODO: Create a Values object containing the values of individual fields from the JSON data**.

7.  On the next line, type the following code:
    ````
    val taxiRecord = taxiEventData.get("eventData")
    val taxiRecordInfo: Values = new Values(
    taxiRecord.get("pickup").asText, taxiRecord.get("dropoff").asText,
    taxiRecord.get("passengers").asText, taxiRecord.get("distance").asText, taxiRecord.get("pickupLatitude").asText,
    taxiRecord.get("pickupLongitude").asText, taxiRecord.get("dropoffLatitude").asText, taxiRecord.get("dropoffLongitude").asText,
    taxiRecord.get("paymentType").asText, taxiRecord.get("fare").asText, taxiRecord.get("extra").asText, taxiRecord.get("tipAmount").asText
    )
    ````

8.  Locate the following comment: **// TODO: Send the data on to the next bolt**.

9.  On the next line, type the following code:
    ````
    collector.emit(taxiRecordInfo)
    ````

10. In the **Project** pane on the left, double-click **StormTopologyDriver**.

11. Locate the following comment: **// TODO: Add the parser bolt to the topology and attach it to the event hubs spout**.

12. On the next line, type the following code:
    ````
    topologyBuilder.setBolt("ParserBolt", new ParserBolt, numTasks).localOrShuffleGrouping("EventHubsSpout").setNumTasks(numTasks)
    ````

13. On the **File** menu, click **Save All**.

#### Task 3: Configure a new shared access policy

1.  In the Azure Portal, in the navigation on the left, click **All resources**, and then click **\<*your name\>\<date*\>ehn**.

2.  On the **\<*your name\>\<date*\>ehn** blade, click **Shared access policies**, and then click **+ Add**.

3.  On the **Add SAS Policy** blade, in the **Policy name** box, type **ListenRule**.

4.  Select the **Listen** check box, leave all the other check boxes cleared, and then click **Create**.

#### Task 4: Configure the Storm streaming topology

1.  In IntelliJ, on the **Run** menu, click **Edit Configurations**.

2.  In the **Run/Debug Configurations** dialog box, on the **Configuration** tab, click in the **Program arguments** box, and then press Shift+Enter.

3.  In the **Program arguments** dialog box, delete the existing code **\<eventhubs-namespace\>**, and then type **\<*your name\>\<date*\>ehn**.

4.  Delete the existing code **\<eventhubs-name\>**, and then type **TaxiEventSource**.

5.  Delete the existing code **\<policy-name\>**, and then type **ListenRule**.

6.  Delete the existing code **\<policy-key\>**.

7.  Switch to Internet Explorer.

8.  In the Azure Portal, on the **Shared access policies** blade, click **ListenRule**.

9.  To the right of the **Primary Key** text box, click **Click to copy**.

10. Switch to IntelliJ.

11. In the **Program arguments** dialog box, press CTRL+V, and then click **OK**.

12. In the **Run/Debug Configurations** dialog box, click **OK**.

#### Task 5: Test the Storm topology

1.  In the **StormTopologyDriver.scala** file, locate the following comment: **// TODO: Build the topology from the definition**.

2.  On the next line, type the following code:
    ````
    val topology : StormTopology = topologyBuilder.createTopology
    ````

3.  Locate the following comment: **// TODO: Start the topology - test using local cluster**.

4.  On the next line, type the following code:
    ````
    config.setMaxTaskParallelism(2)
    val cluster : LocalCluster = new LocalCluster
    cluster.submitTopology("test", config, topology)
    ````

5.  Locate the following comment: **// TODO: Stop the local cluster**.

6.  On the next line, type the following code:
    ````
    cluster.shutdown()
    ````

7.  On the **File** menu, click **Save All**.

8.  On the **Run** menu, click **Run**.

9.  In the **Run** dialog box, click **StormProcessor**.

10. If the **Windows Security Alert** dialog box appears, click **Allow access**.

11. When the topology stops, on the **File** menu, click **Close Project**. If the topology is taking too long to finish (more than a couple of minutes), press Ctrl+F2 to terminate it.

**Results**: At the end of this exercise, you will have an Apache Storm streaming application that obtains data from an Azure event hub and parses that data.

### Exercise 5: Write data from the Storm topology to an Azure Storage table

#### Task 1: Create an Azure Storage account

1.  Switch to Internet Explorer.

2.  In the Azure Portal, in the navigation on the left, click **+ New**, click **Storage**, and then click **Storage account - blob, file, table, queue**.

3.  In the **Create storage account** blade, enter the following information, and then click **Create**:

    -   **Name**: \<*your name\>\<date*\>sta (must be unique)

    -   **Deployment model**: Resource manager

    -   **Account kind**: General purpose

    -   **Performance**: Standard

    -   **Replication**: Locally-redundant storage (LRS)

    -   **Storage encryption**: Disabled

    -   **Secure transfer required**: Disabled

    -   **Subscription**: your subscription

    -   **Resource group (Use existing)**: StormRG

    -   **Location**: Choose your region

#### Task 2: Write data to the Azure Storage table

1.  In the **Welcome to IntelliJ IDEA** dialog box, click **Open**.

2.  In the **Open File or Project** dialog box, browse to **E:\\Labfiles\\Lab12\\Starter\\StormProcessor - Exercise 5**, and then click **OK**.

3.  If the **Tip of the Day** dialog box appears, click **Close**.

4.  In the center pane, click on the **SaveToTableBolt.scala** tab, and then locate the following comment: **// TODO: Retrieve the input fields**.

5.  On the next line, type the following code:
    ````
    val pickup: String = input.getString(0)

    val dropoff: String = input.getString(1)

    val passengers: String = input.getString(2)

    val distance: String = input.getString(3)

    val pickupLatitude: String = input.getString(4)

    val pickupLongitude: String = input.getString(5)

    val dropoffLatitude: String = input.getString(6)

    val dropoffLongitude: String = input.getString(7)

    val paymentType: String = input.getString(8)

    val fare: String = input.getString(9)

    val additionalCharges: String = input.getString(10)

    val tip: String = input.getString(11)
    ````

6.  Locate the following comment: **// TODO: Connect to the storage account**.

7.  On the next line, type the following code:
    ````
    val accountName: String =
    inputOptions(Symbol(ClientArgumentKeys.StorageAccountName)).asInstanceOf[String]

    val accountKey: String =
    inputOptions(Symbol(ClientArgumentKeys.StorageKey)).asInstanceOf[String]

    val connectionString: String =
    s"DefaultEndpointsProtocol=http;AccountName=$accountName;AccountKey=$accountKey"

    val storageAccount: CloudStorageAccount =
    CloudStorageAccount.parse(connectionString)
    ````

8.  Locate the following comment: **// TODO: Create a table for the day specified in the pickup_datetime field (if it doesn't already exist)**.

9.  On the next line, type the following code:
    ````
    val tableClient: CloudTableClient =
    storageAccount.createCloudTableClient()

    println("SaveToTableBolt. Pickup is: " + pickup)

    val pickupDay: String = pickup.substring(8, 10)

    val pickupMonth: String = pickup.substring(5, 7)

    val pickupYear: String = pickup.substring(0, 4)

    val tableName: String = "TaxiData" + pickupYear + pickupMonth +
    pickupDay

    println("SaveToTableBolt. Table name is: " + tableName)

    val cloudTable: CloudTable = tableClient.getTableReference(tableName)

    cloudTable.createIfNotExists()
    ````

10. Locate the following comment: **// TODO: Create a table entity containing the taxi event data**.

11. On the next line, type the following code:
    ````
    val taxiDataEntity: TaxiDataEntity = new TaxiDataEntity(paymentType)

    taxiDataEntity.setPickup(pickup)

    taxiDataEntity.setDropoff(dropoff)

    taxiDataEntity.setPassengers(passengers)

    taxiDataEntity.setDistance(distance)

    taxiDataEntity.setPickupLatitude(pickupLatitude)

    taxiDataEntity.setPickupLongitude(pickupLongitude)

    taxiDataEntity.setDropoffLatitude(dropoffLatitude)

    taxiDataEntity.setDropoffLongitude(dropoffLongitude)

    taxiDataEntity.setPaymentKind(paymentType)

    taxiDataEntity.setFare(fare)

    taxiDataEntity.setAdditionalCharges(additionalCharges)

    taxiDataEntity.setTip(tip)
    ````

12. Locate the following comment: **// TODO: Save the taxi entity to table storage**.

13. On the next line, type the following code:
    ````
    cloudTable.execute(TableOperation.insertOrReplace(taxiDataEntity))
    ````

14. Locate the following comment: **// TODO: Pass the data on to the next bolt**.

15. In the next line, type the following code:
    ````
    collector.emit(new Values(pickup, dropoff, passengers, distance,
    pickupLatitude, pickupLongitude, dropoffLatitude, dropoffLongitude,
    paymentType, fare, additionalCharges, tip))
    ````

16. On the **File** menu, click **Save All**.

#### Task 3: Add the save table bolt to the Storm topology

1.  In the center pane, click on the **StormTopologyDriver.scala** tab, and then locate the following comment: **// TODO: Add the SaveToTable bolt and attach it to the parser bolt**.

2.  On the next line, type the following code:
    ````
    topologyBuilder.setBolt("SaveToTableBolt", new SaveToTableBolt,
    numTasks).localOrShuffleGrouping("ParserBolt").setNumTasks(numTasks)
    ````

3.  On the **File** menu, click **Save All**.

#### Task 4: Configure and test the updated topology

1.  On the **File** menu, point to **Open Recent**, and then click **StormProcessor - Exercise 4**.

2.  In the **Open Project** dialog box, click **New Window**.

3.  Switch to the **StormProcessor - Exercise 4** project.

4.  On the **Run** menu, click **Edit Configurations**.

5.  In the **Run/Debug Configurations** dialog box, in the **Program arguments** text box, select all the text, press Ctrl+C, and then click **Cancel**.

6.  On the **File** menu, click **Close Project**.

7.  In the **StormProcessor - Exercise 5** project.

8.  On the **Run** menu, click **Edit Configurations**.

9.  In the **Run/Debug Configations** dialog box, in the **Program arguments** text box, select all the code, and then press Ctrl+V.

10. Press Shift+Enter.

11. In the **Program arguments** dialog box, delete the existing code **\<storage-account\>**, and then type **\<*your name\>\<date*\>sta**.

12. Delete the existing code **\<storage-key\>**.

13. Switch to Internet Explorer.

14. In the navigation on the left, click **All resources**.

15. In the list of resources, click the storage account you created in the first task of this exercise.

16. In the Storage account blade, click **Access keys**.

17. To the right of **key1**, in the **Key** column, click **Click to copy**.

18. Switch to IntelliJ IDEA.

19. In the **Program arguments** dialog box, press Ctrl+V, and then click **OK**.

20. In the **Run/Debug Configurations** dialog box, click **OK**.

21. On the **File** menu, click **Save All**.

22. On the **Run** menu, click **Run**.

23. In the **Run** dialog box, click **StormProcessor**.

24. When the topology stops, on the **File** menu, click **Close Project**. If the topology is taking too long to finish (more than a couple of minutes), press Ctrl+F2 to terminate it.

#### Task 5: View the data saved by the SaveToTableBolt

1.  On the Start menu, type **Azure Storage**, and then click **Microsoft Azure Storage Explorer**.

2.  In the **Connect to Azure Storage** dialog box, ensure that **Add an** **Azure Account** is selected, and then click **Sign in**.

3.  In the **Sign in to your account** dialog box, enter the credentials of the Microsoft account that is associated with your Azure Learning Pass subscription, and then click **Sign in**.

4.  Under your Azure Learning Pass subscription, under **Storage Accounts**, expand your storage account.

5.  Expand **Tables**, and then click anyone of the **TaxiData+\<date\>** tables.

6.  Close Microsoft Azure Storage Explorer.

**Results**: At the end of this exercise, you will have an Apache Storm topology that stores data in an Azure Storage table.

### Exercise 6: Display data in Power BI

#### Task 1: Create a Power BI streaming dataset

1.  In Internet Explorer, open a new tab, and then browse to **http://www.powerbi.com**.

2.  Click **Sign in**, and sign in using your Power BI credentials.

3.  Close the **GetData** dialog box.

4.  Click **+ Create**, and click **Streaming dataset**.

5.  On the **New streaming dataset** blade, click **API**, and then click **Next**.

6.  On the **New streaming dataset** blade, enter the following details, and then click **Create**:

    -   **Dataset name**: Taxi Data

    -   Values from stream:

        -   **Passengers**: Number

        -   **Distance**: Number

        -   **Fares**: Number

        -   **Tips**: Number

        -   **AvgPassengers**: Number

        -   **AvgDistance**: Number

        -   **AvgFare**: Number

        -   **AvgTip**: Number

7.  Select the **Push URL** value and then press Ctrl+C.

8.  Open Notepad, and then press Ctrl+V.

9.  On the **File** menu, click **Save**.

10. In the **Save As** dialog box, browse to **E:\\Labfiles\\Lab12**.

11. In the **File name** text box, type **PowerBIPushURL.txt**, and then click **Save**.

12. Leave Notepad open while you complete the next exercise.

13. Switch back to Internet Explorer, and then click **Done**.

#### Task 2: Create a Power BI dashboard

1.  In Internet Explorer, on the **Power BI** page, click **Dashboards**.

2.  Click **+ Create**, and click **Dashboard**.

3.  In the **Create Dashboard** dialog box, in the **Dashboard name** box, type **Taxi Data**, and then click **Create**.

4.  Click **+ Add** tile.

5.  On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

6.  On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

7.  In the **Visualization Type** list, click **Card**.

8.  Under **Fields**, click **+ Add value**.

9.  In the **Fields** list, click **Passengers**, and then click **Next**.

10. On the **Tile details** blade, in the **Title** box, type **Number of Passengers**, and then click **Apply**.

11. Click **+ Add** **tile**.

12. On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

13. On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

14. On the **Add a custom streaming data tile** blade, in the **Visualization Type** list, click **Card**.

15. Under **Fields**, click **+ Add value**.

16. In the **Fields** list, click **Distance**, and then click **Next**.

17. On the **Tile details** blade, in the **Title** box, type **Distance**, and then click **Apply**.

18. Click **+ Add** tile.

19. On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

20. On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

21. On the **Add a custom streaming data tile** blade, in the **Visualization Type** list, click **Card**.

22. Under **Fields**, click **+ Add value**.

23. In the **Fields** list, click **Fares**, and then click **Next**.

24. In the **Tile details** blade, in the **Title** box, type **Fares**, and then click **Apply**.

25. Click **+ Add** **tile**.

26. On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

27. On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

28. On the **Add a custom streaming data tile** blade, in the **Visualization Type** list, click **Card**.

29. Under **Fields**, click **+ Add value**.

30. In the **Fields** list, click **Tips**, and then click **Next**.

31. On the **Tile details** blade, in the **Title** box, type **Tips**, and then click **Apply**.

32. Click **+ Add tile**.

33. On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

34. On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

35. On the **Add a custom streaming data tile** blade, in the **Visualization Type** list, click **Card**.

36. Under **Fields**, click **+ Add value**.

37. In the **Fields** list, click **AvgPassengers**, and then click **Next**.

38. On the **Tile details** blade, in the **Title** box, type **Average Passengers**, and then click **Apply**.

39. Click **+ Add tile**.

40. On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

41. On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

42. On the **Add a custom streaming data tile** blade, in the **Visualization Type** list, click **Card**.

43. Under **Fields**, click **+ Add value**.

44. In the **Fields** list, click **AvgDistance**, and then click **Next**.

45. On the **Tile details** blade, in the **Title** box, type **Average Distance**, and then click **Apply**.

46. Click **+ Add** tile.

47. On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

48. On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

49. On the **Add a custom streaming data tile** blade, in the **Visualization Type** list, click **Card**.

50. Under **Fields**, click **+ Add value**.

51. In the **Fields** list, click **AvgFare**, and then click **Next**.

52. On the **Tile details** blade, in the **Title** box, type **Average Fare**, and then click **Apply**.

53. Click **+ Add** **tile**.

54. On the **Add tile** blade, click **CUSTOM STREAMING DATA**, and then click **Next**.

55. On the **Add a custom streaming data tile** blade, click **Taxi Data**, and then click **Next**.

56. On the **Add a custom streaming data tile** blade, in the **Visualization Type** list, click **Card**.

57. Under **Fields**, click **+ Add value**.

58. In the **Fields** list, click **AvgTip**, and then click **Next**.

59. On the **Tile details** blade, in the **Title** box, type **Average Tip**, and then click **Apply**.

#### Task 3: Add the Statistics bolt to the Storm topology

1.  Switch to IntelliJ IDEA Community Edition.

2.  In the **Welcome to IntelliJ IDEA** dialog box, click **Open**.

3.  In the **Open File or Project** dialog box, browse to **E:\\Labfiles\\Lab12\\Starter\\StormProcessor - Exercise 6**, and then click **OK**.

4.  If the **Tip of the Day** dialog box appears, click **Close**.

5.  In the center pane, click on the **StatisticsBolt.scala** tab, and then locate the following comment: **// TODO: Iterate through the tuples for the current time window and accumulate the results**.

6.  In the next lines, type the following code:
    ````
    val iterator = input.get.iterator

    while (iterator.hasNext) {

    val tuple = iterator.next

    numTuples += 1

    val passengers: Int = tuple.getString(2).toInt

    totalPassengers += passengers

    val distance: Float = tuple.getString(3).toFloat

    totalDistance += distance

    val fare: Float = tuple.getString(9).toFloat

    totalFares += fare

    val tip: Float = tuple.getString(11).toFloat

    totalTips += tip

    }
    ````

7.  Locate the following comment: **// TODO: Send the results to the PowerBI dashboard**.

8.  On the next line, type the following code:
    ````
    emitStatsToDashboard(StatisticsData(totalPassengers, totalDistance,
    totalFares, totalTips, totalPassengers / numTuples, totalDistance /
    numTuples, totalFares / numTuples, totalTips/numTuples, numTuples))
    ````

9.  Locate the following comment: **// TODO: Format the data as a JSON string**.

10. On the next line, type the following code:
    ````
    implicit val formats = DefaultFormats

    val jsonData = "[" + new Gson().toJson(data) + "]"
    ````

11. Locate the following comment: **// TODO: Post the data to the endpoint for the Power BI dashboard**.

12. On the next line, type the following code:
    ````
    val endpoint: String =
    inputOptions(Symbol(ClientArgumentKeys.DashboardEndpoint)).asInstanceOf[String]

    val post = new HttpPost(endpoint)

    post.setEntity(new StringEntity(jsonData))

    val client: HttpClient = HttpClients.createDefault

    val response = client.execute(post)
    ````

13. Locate the following comment: **// TODO: Log the responses**.

14. On the next line, type the following code:
    ````
    println("StatisticsBolt response:")

    response.getAllHeaders.foreach(arg => println(arg))
    ````

15. Locate the following comment: **// TODO: Define the format of the JSON data sent to Power BI**.

16. On the next line, type the following code:
    ````
    case class StatisticsData(val Passengers: Int, val Distance: Float, val
    Fares: Float, val Tips: Float,

    val AvgPassengers: Int, val AvgDistance: Float, val AvgFare: Float, val
    AvgTip: Float, val NumTrips: Int)
    ````

17. In the center pane, click on the **StormTopologyDriver.scala** tab, and then locate the following comment: **// TODO: Add the Statistics bolt and attach it to the parser bolt. It should provide a rolling window of 30 seconds of data**.

18. On the next line, type the following code:
    ````
    topologyBuilder.setBolt("StatisticsBolt", new
    StatisticsBolt().withWindow(new BaseWindowedBolt.Duration(30,
    TimeUnit.SECONDS)),
    1).localOrShuffleGrouping("ParserBolt").setNumTasks(1)
    ````

19. On the **File** menu, click **Save All**.

#### Task 4: Configure and test the updated topology

1.  On the **File** menu, point to **Open Recent**, and then click **StormProcessor - Exercise 5**.

2.  In the **Open Project** dialog box, click **New Window**.

3.  Switch to the **StormProcessor - Exercise 5** project.

4.  On the **Run** menu, click **Edit Configurations**.

5.  In the **Run/Debug Configurations** dialog box, in the **Program arguments** text box, select all the text, press Ctrl+C, and then click **Cancel**.

6.  On the **File** menu, click **Close Project**.

7.  In the **StormProcessor - Exercise 6** project.

8.  On the **Run** menu, click **Edit Configurations**.

9.  In the **Run/Debug Configations** dialog box, in the **Program arguments** text box, select all the code, and then press Ctrl+V.

10. Press Shift+Enter.

11. In the **Program arguments** dialog box, delete the existing code **\<dashboard-endpoint\>**.

12. Open the **PowerBIPushURL.txt** file that you created in the first task of this exercise.

13. Select all the text in the file, and then press Ctrl+C.

14. Switch to IntelliJ IDEA.

15. In the **Program arguments** dialog box, press Ctrl+V, and then click **OK**.

16. In the **Run/Debug Configurations** dialog box, click **OK**.

17. On the **File** menu, click **Save All**.

18. On the **Run** menu, click **Run**.

19. In the **Run** dialog box, click **StormProcessor**.

20. Switch to Internet Explorer.

21. View statistics in the Power Bi Dashboard.

22. Switch to IntelliJ IDEA.

23. When the topology stops, on the **File** menu, click **Close Project**. If the topology is taking too long to finish (more than a couple of minutes), then press Ctrl+F2 to terminate it.

**Results**: At this end of this exercise, you will have an Apache Storm topology that communicates data to Power BI for display.

### Exercise 7: Persist data from the Storm topology to Azure SQL Database

#### Task 1: Create an Azure SQL Server and Database

1.  Switch to Internet Explorer.

2.  In the Azure Portal, in the navigation on the left, click **+ New**, click **Databases**, and then click **SQL Database**.

3.  On the **SQL Database** blade, enter the following information, and then click **Create**:

    -   **Database name**: *\<your name\>\<date\>db* (must be unique)

    -   **Subscription**: your subscription.

    -   **Resource group (Use Existing)**: StormRG

    -   **Select source**: Blank database

    -   **Server**: Click **Configure required settings**, enter the following values, and then click **Select**:

        -   **Server name**: *\<your name\>\<date\>srv*

        -   **Server admin login**: student

        -   **Password**: Pa55w.rd

        -   **Confirm password**: Pa55w.rd

        -   **Location**: Accept the default value

        -   **Allow azure services to access server**: selected

    -   **Want to use SQL elastic pool**: Not now

    -   **Pricing tier**: Accept the default pricing tier

    -   **Collation**: Accept the default value

4.  Wait until the server and database have been created before continuing.

5.  In the Azure Portal, click **Resource groups**, click the resource group that contains your database, and then click your database.

6.  On the SQL database blade, click **Set server firewall**.

7.  In the **Firewall settings** blade, click **Add client IP**, and then click **Save**.

8.  In the **Success** message box, click **OK**.

9.  Close the **Firewall settings** blade.

10. On the SQL database blade, click **Tools**.

11. On the **Tools** blade, click **Query editor (preview)**.

12. If the **Preview terms** blade appears, select the **This is a preview feature** check box, and then click **OK**.

13. On the **Query editor (preview)** blade, click **Login**.

14. In the **Login** message box, log in as **student** with the password **Pa55w.rd**, and then click **OK**.

15. On the **Query editor** blade, click **Open query**.

16. In the **Choose File to Upload** dialog box, navigate to the **E:\\Labfiles\\Lab12\\Starter** folder, click
    **disputed_trips.sql**, and then click **Open**.

17. On the **Query editor** blade, click **Run**. Verify that the script runs without any errors.

#### Task 2: Add the SaveToSQL bolt to the Storm topology

1.  Switch to IntelliJ IDEA Community Edition.

2.  In the **Welcome to IntelliJ IDEA** dialog box, click **Open**.

3.  In the **Open File or Project** dialog box, browse to **E:\\Labfiles\\Lab12\\Starter\\StormProcessor - Exercise 7** folder, and then click **OK**.

4.  If the **Tip of the Day** dialog appears, click **Close**.

5.  In the center pane, click the **SaveToSQLBolt.scala** tab, and then locate the following comment: **// TODO: Create the connection string for Azure SQL Database**.

6.  Add the following code directly below this comment. This code creates a connection string based on command-line parameters that you will specify later:
    ````
    val sqlServer: String =
    inputOptions(Symbol(ClientArgumentKeys.SQLServer)).asInstanceOf[String]

    val sqlDatabase: String =
    inputOptions(Symbol(ClientArgumentKeys.SQLDatabase)).asInstanceOf[String]

    val sqlAccountName: String =
    inputOptions(Symbol(ClientArgumentKeys.SQLAccountName)).asInstanceOf[String]

    val sqlPassword: String =
    inputOptions(Symbol(ClientArgumentKeys.SQLPassword)).asInstanceOf[String]

    val connectionString: String =
    s"jdbc:sqlserver://$sqlServer.database.windows.net:1433;database=$sqlDatabase;user=$sqlAccountName@$sqlServer;password=$sqlPassword;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;"
    ````

7.  Locate the following comment: **// TODO: Connect to the database**.

8.  Add the following code directly below this comment:
    ````
    connection = DriverManager.getConnection(connectionString)

    println("SaveToSQLBolt. Connected to database")
    ````

9.  Locate the following comment: **// TODO: Insert a new record containing the pertinent data**.

10. Add the following code directly below this comment:
    ````
    var insertString: String = "INSERT INTO taxi.disputed_trips (Pickup,
    Dropoff, Passengers, Fare, PaymentType) VALUES(?, ?, ?, ?, ?)"

    var statement: PreparedStatement =
    connection.prepareStatement(insertString)

    val format: SimpleDateFormat = new SimpleDateFormat("yyyy-MM-dd
    hh:mm")

    statement.setTimestamp(1, new Timestamp(format.parse(pickup).getTime))

    statement.setTimestamp(2, new Timestamp(format.parse(dropoff).getTime))

    statement.setInt(3, passengers.toInt)

    statement.setDouble(4, fare.toDouble)

    statement.setInt(5, paymentType.toInt)

    val numInserted: Int = statement.executeUpdate()
    ````

11. Locate the following comment: **// TODO: Tidy up**.

12. Add the following code directly below this comment:
    ````
    statement.close()
    ````

13. Locate the following comment: **// TODO: Close the connection to the database**.

14. Add the following code directly below this comment:
    ````
    if (connection != null && !connection.isClosed)

    connection.close()
    ````

15. In the center pane, click on the **StormTopologyDriver.scala** tab, and then locate the following comment: **// TODO: Add the SaveToSQL bolt and attach it to the SaveToTable bolt**.

16. On the next line, type the following code:
    ````
    topologyBuilder.setBolt("SaveToSQLBolt", new SaveToSQLBolt,
    numTasks).localOrShuffleGrouping("SaveToTableBolt").setNumTasks(numTasks)
    ````

17. On the **File** menu, click **Save All**.

#### Task 3: Configure and test the updated topology

1.  On the **File** menu, point to **Open Recent**, and then click **StormProcessor - Exercise 6**.

2.  In the **Open Project** dialog box, click **New Window**.

3.  Switch to the **StormProcessor - Exercise 6** project.

4.  On the **Run** menu, click **Edit Configurations**.

5.  In the **Run/Debug Configurations** dialog box, in the **Program arguments** text box, select all the text, press Ctrl+C, and then click **Cancel**.

6.  On the **File** menu, click **Close Project**.

7.  In the **StormProcessor - Exercise 7** project.

8.  On the **Run** menu, click **Edit Configurations**.

9.  In the **Run/Debug Configations** dialog box, in the **Program arguments** text box, select all the code, and then press Ctrl+V.

10. Press Shift+Enter.

11. In the **Program arguments** dialog box, delete the existing code **\<sql-account-name\>**, and then type **student**.

12. Delete the existing code **\<sql-password\>**, and then type **Pa55w.rd**.

13. Delete the existing code **\<sql-server\>**, and then type **\<*your Azure SQL Database server name*\>**.

14. Delete the existing code **\<sql-database\>**, type **\<*your database*\>**, and then click **OK**.

15. In the **Run/Debug Configurations** dialog box, click **OK**.

16. On the **File** menu, click **Save All**.

17. On the **Run** menu, click **Run**.

18. In the **Run** dialog box, click **StormProcessor**.

19. When the topology stops, on the **File** menu, click **Exit**. If the topology is taking too long to finish (more than a couple of minutes), press Ctrl+F2 to terminate it.

20. In the **Confirm Exit** dialog box, click **Exit**.

#### Task 4: View the data saved by the SaveToSQL bolt

1.  Return to the Azure Portal in Internet Explorer.

2.  In the Azure Portal, click **Resource groups**, click the resource group that contains your database, and then click your database.

3.  On the SQL database blade, click **Tools**.

4.  On the **Tools** blade, click **Query editor (preview)**.

5.  On the **Query editor (preview)** blade, click **Login**.

6.  In the **Login** message box, log in as **student** with the password **Pa55w.rd**, and then click **OK**.

7.  On the **Query editor** blade, type the following query:
    ````
    SELECT * FROM taxi.disputed_trips
    ````

8.  Click **Run**. The data for a number of disputed trips should be displayed.

#### Task 5: Lab clean-up

1.  In the Microsoft Azure Portal, in the left-hand menu, click **Resource groups**.

2.  On the **Resource groups** blade, click your resource group.

3.  On the Resource group blade, click **Delete**.

4.  On the confirmation blade, type the name of your resource group, and then click **Delete**.

5.  Wait for your resource group to be deleted, and then click **All resources**.

6.  Verify that the event hub, SQL server, SQL database, and the storage account that were created, have all been removed.

**Results**: At the end of this exercise, you will have an Apache Storm topology that writes data to Azure SQL Database.

Â©2018 Microsoft Corporation. All rights reserved.

The text in this document is available under the [Creative Commons Attribution 3.0 License](https://creativecommons.org/licenses/by/3.0/legalcode), additional terms may apply. All other content contained in this document (including, without limitation, trademarks, logos, images, etc.) are **not** included within the Creative Commons license grant. This document does not provide you with any legal rights to any intellectual property in any Microsoft product. You may copy and use this document for your internal, reference purposes.

This document is provided "as-is." Information and views expressed in this document, including URL and other Internet Web site references, may change without notice. You bear the risk of using it. Some examples are for illustration only and are fictitious. No real association is intended or inferred. Microsoft makes no warranties, express or implied, with respect to the information provided here.
